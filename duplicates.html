<!DOCTYPE html>
<html>
<head>
<title>Duplicate Run Finder</title>
<style>
body { font-family: sans-serif; }
#results { margin-top: 20px; }
.run-link { display: block; }
</style>
</head>
<body>

<h1>Duplicate Run Finder</h1>

<label for="game-id">Game ID:</label>
<input type="text" id="game-id" placeholder="Enter Game ID" value="your_game_id_here">
<button id="find-duplicates">Find Duplicates</button>

<div id="results"></div>

<script>
const apiBaseUrl = "https://www.speedrun.com/api/v1";

async function getRuns(gameId, status = "verified", offset = 0) {
    const url = `${apiBaseUrl}/runs?game=${gameId}&status=${status}&offset=${offset}&max=200`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
    }
    return (await response.json()).data;
}

async function findDuplicateRuns() {
    const gameId = document.getElementById("game-id").value;
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = ""; // Clear previous results

    try {
        let allRuns = [];
        let offset = 0;
        let batch;

        do {  // Use do...while to ensure at least one request is made.
            batch = await getRuns(gameId, "verified", offset);
            allRuns.push(...batch);  // Spread operator to add elements efficiently
            offset += 200;
        } while (batch.length === 200)

        const seenRuns = new Map();
        const duplicates = [];

        for (const run of allRuns) {
            const playerIds = run.players.filter(p => "id" in p).map(p => p.id).sort();
            const key = JSON.stringify([playerIds, run.times.primary, run.category]); // Convert to string for Map key

            if (seenRuns.has(key)) {
                duplicates.push([seenRuns.get(key), run]);
            } else {
                seenRuns.set(key, run);
            }
        }


        if (duplicates.length > 0) {
            resultsDiv.innerHTML = "<h2>Duplicate Runs:</h2>";
            for (const [run1, run2] of duplicates) {
                resultsDiv.innerHTML += `<p><a class="run-link" href="${run1.weblink}" target="_blank">${run1.weblink}</a></p>`;
                resultsDiv.innerHTML += `<p><a class="run-link" href="${run2.weblink}" target="_blank">${run2.weblink}</a></p>`;
                resultsDiv.innerHTML += "<hr>"; // Separator
            }

        } else {
            resultsDiv.textContent = "No duplicate runs found.";
        }
    } catch (error) {
        resultsDiv.textContent = `Error: ${error.message}`;
    }
}

document.getElementById("find-duplicates").addEventListener("click", findDuplicateRuns);

</script>

</body>
</html>
